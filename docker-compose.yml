version: '3.8'

services:
  # Main Streamlit Application
  app:
    build: .
    container_name: ai-homework-grader
    ports:
      - "8501:8501"
    volumes:
      # Mount data directories for persistence
      - ./data:/app/data
      - ./rubrics:/app/rubrics
      - ./sample_datasets:/app/sample_datasets
      - ./graded_submissions:/app/graded_submissions
      - ./training_data:/app/training_data
      - ./logs:/app/logs
      - ./grading_database.db:/app/grading_database.db
    environment:
      - PYTHONUNBUFFERED=1
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    restart: unless-stopped
    networks:
      - grader-network

  # GPT-OSS Server (Mac Studio 1)
  gpt-oss-server:
    build:
      context: .
      dockerfile: Dockerfile.gpt-oss
    container_name: gpt-oss-server
    ports:
      - "5001:5001"
    environment:
      - MODEL_NAME=lmstudio-community/gpt-oss-120b-MLX-8bit
      - MAX_TOKENS=800
      - TEMPERATURE=0.3
    restart: unless-stopped
    networks:
      - grader-network
    # Note: This requires MLX which only works on Apple Silicon
    # For non-Mac deployment, use alternative models

  # Qwen Server (Mac Studio 2)
  qwen-server:
    build:
      context: .
      dockerfile: Dockerfile.qwen
    container_name: qwen-server
    ports:
      - "5002:5002"
    environment:
      - MODEL_NAME=mlx-community/Qwen3-Coder-30B-A3B-Instruct-8bit
      - MAX_TOKENS=1200
      - TEMPERATURE=0.1
    restart: unless-stopped
    networks:
      - grader-network
    # Note: This requires MLX which only works on Apple Silicon

networks:
  grader-network:
    driver: bridge

volumes:
  grading-data:
    driver: local
